<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PDF Chat Assistant</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- HTMX for AJAX interactions -->
  <script src="https://unpkg.com/htmx.org@1.9.3"></script>
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .chat-container {
      height: calc(100vh - 120px);
      overflow-y: auto;
      scroll-behavior: smooth;
    }
    .message-appear {
      animation: fadeIn 0.3s ease-in-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    /* Custom scrollbar */
    .chat-container::-webkit-scrollbar {
      width: 6px;
    }
    .chat-container::-webkit-scrollbar-track {
      background: #f1f1f1;
    }
    .chat-container::-webkit-scrollbar-thumb {
      background: #cbd5e0;
      border-radius: 3px;
    }
    .chat-container::-webkit-scrollbar-thumb:hover {
      background: #a0aec0;
    }
    /* Markdown styling */
    .markdown p {
      margin-bottom: 0.75rem;
    }
    .markdown code {
      background-color: #f0f0f0;
      padding: 0.1rem 0.3rem;
      border-radius: 3px;
      font-family: monospace;
      font-size: 0.9em;
    }
    .markdown pre {
      background-color: #f7fafc;
      padding: 1rem;
      border-radius: 5px;
      overflow-x: auto;
      margin: 1rem 0;
    }
    .markdown ul, .markdown ol {
      margin-left: 1.5rem;
      margin-bottom: 1rem;
    }
    .markdown ul {
      list-style-type: disc;
    }
    .markdown ol {
      list-style-type: decimal;
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans min-h-screen">
  <div class="flex flex-col h-screen max-w-5xl mx-auto">
    <!-- Header -->
    <header class="bg-white border-b border-gray-200 py-4 px-6 flex justify-between items-center shadow-sm">
      <div class="flex items-center space-x-2">
        <i class="fas fa-robot text-green-500 text-xl"></i>
        <h1 class="text-xl font-semibold">PDF Chat Assistant</h1>
      </div>
    </header>

    <!-- Chat Container -->
    <div class="flex-grow overflow-hidden flex flex-col">
      <div id="chat-history" class="chat-container p-6 flex-grow overflow-y-auto space-y-6">
        <!-- Welcome message if no history -->
        {% if not history %}
        <div class="text-center py-12">
          <div class="inline-block p-3 bg-blue-50 rounded-full mb-4">
            <i class="fas fa-robot text-4xl text-green-500"></i>
          </div>
          <h2 class="text-xl font-medium text-gray-700 mb-2">Welcome to PDF Chat Assistant</h2>
          <p class="text-gray-500 max-w-lg mx-auto">
            Ask questions about your uploaded documents and I'll help you find the information you need.
          </p>
        </div>
        {% endif %}

        <!-- Chat messages -->
        {% for user_msg, bot_msg in history %}
        <div class="message-appear user-message flex items-start gap-4">
          <div class="w-8 h-8 rounded-full bg-blue-600 flex-shrink-0 flex items-center justify-center text-white">
            <i class="fas fa-user text-sm"></i>
          </div>
          <div class="flex-grow max-w-[85%] sm:max-w-[90%]">
            <div class="bg-blue-50 p-3 rounded-lg shadow-sm">
              {{ user_msg }}
            </div>
          </div>
        </div>
        <div class="message-appear bot-message flex items-start gap-4">
          <div class="w-8 h-8 rounded-full bg-green-600 flex-shrink-0 flex items-center justify-center text-white">
            <i class="fas fa-robot text-sm"></i>
          </div>
          <div class="flex-grow max-w-[85%] sm:max-w-[90%]">
            <div class="bg-white p-4 rounded-lg shadow-sm markdown">
              {{ bot_msg }}
            </div>
          </div>
        </div>
        {% endfor %}
      </div>

      <!-- Input Area -->
      <div class="p-4 border-t border-gray-200 bg-white">
        <form hx-post="{% url 'ask' %}" hx-target="#chat-history" hx-swap="beforeend"
              hx-on::after-request="this.reset(); document.querySelector('.chat-container').scrollTop = document.querySelector('.chat-container').scrollHeight;"
              hx-indicator="#sending-indicator" class="flex space-x-2 items-center">
          {% csrf_token %}
          <div class="relative flex-grow">
            <input type="text" name="question"
                  placeholder="Ask a question about your document..."
                  class="w-full p-3 pr-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                  required>
            <div id="sending-indicator" class="htmx-indicator absolute right-3 top-3 text-gray-400">
              <i class="fas fa-spinner fa-spin"></i>
            </div>
          </div>
          <button type="submit" class="bg-green-600 hover:bg-green-700 text-white p-3 rounded-lg transition duration-200 flex items-center justify-center min-w-[50px]">
            <i class="fas fa-paper-plane"></i>
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- HTMX CSRF configuration script -->
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      // Configure HTMX with CSRF token
      document.body.addEventListener("htmx:configRequest", function(event) {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        event.detail.headers["X-CSRFToken"] = csrfToken;
      });

      // Scroll to bottom of chat on page load
      const chatContainer = document.querySelector('.chat-container');
      if (chatContainer) {
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }
    });
  </script>
</body>
</html>