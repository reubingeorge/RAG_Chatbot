<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manage Documents | PDF Chat Assistant</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- HTMX for AJAX interactions -->
  <script src="https://unpkg.com/htmx.org@1.9.3"></script>
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes pulse {
      0% { transform: scale(0.95); opacity: 0.7; }
      50% { transform: scale(1.05); opacity: 1; }
      100% { transform: scale(0.95); opacity: 0.7; }
    }
    
    @keyframes progress {
      0% { width: 0%; }
      20% { width: 20%; }
      40% { width: 50%; }
      70% { width: 75%; }
      95% { width: 90%; }
      100% { width: 100%; }
    }
    
    .fade-in {
      animation: fadeIn 0.3s ease-in-out;
    }
    
    .pulse-animation {
      animation: pulse 1.5s infinite;
    }
    
    .file-list-item {
      transition: all 0.2s ease-in-out;
    }
    
    .file-list-item:hover {
      transform: translateX(5px);
      background-color: #f9fafb;
    }
    
    .progress-bar {
      animation: progress 8s ease-in-out forwards;
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans min-h-screen py-8">
  <div class="max-w-4xl mx-auto p-4">
    <!-- Header -->
    <header class="bg-white border-b border-gray-200 py-4 px-6 rounded-t-lg shadow-sm mb-6 flex justify-between items-center">
      <div class="flex items-center space-x-2">
        <i class="fas fa-file-pdf text-red-500 text-xl"></i>
        <h1 class="text-xl font-semibold">PDF Chat Assistant</h1>
      </div>
      <a href="{% url 'index' %}" class="bg-blue-50 hover:bg-blue-100 text-blue-600 px-4 py-2 rounded-md transition duration-200 flex items-center">
        <i class="fas fa-comments mr-2"></i>
        <span>Go to Chat</span>
      </a>
    </header>
    
    <!-- Main Content -->
    <div class="bg-white rounded-lg shadow-sm p-6">
      <!-- Section Title -->
      <div class="mb-6">
        <h2 class="text-lg font-medium flex items-center text-blue-800">
          <i class="fas fa-folder-open text-yellow-500 mr-2"></i>
          Your Uploaded Documents
        </h2>
        <p class="text-gray-500 text-sm mt-1">Manage your PDF files or upload new ones</p>
      </div>
      
      <!-- Upload Section -->
      <div class="mb-6 pb-6 border-b border-gray-200">
        <h3 class="text-md font-medium mb-4 flex items-center">
          <i class="fas fa-upload text-blue-500 mr-2"></i>
          Upload New Documents
        </h3>
        
        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-400 transition-colors" id="drop-area">
          <!-- Upload form with explicit id -->
          <form id="upload-form"
                hx-post="{% url 'upload' %}"
                hx-encoding="multipart/form-data"
                hx-target="#upload-result"
                hx-swap="innerHTML"
                hx-indicator="#processing-animation"
                class="flex flex-col items-center">
            {% csrf_token %}
            <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='50' height='50' viewBox='0 0 24 24' fill='none' stroke='%23d1d5db' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4'%3E%3C/path%3E%3Cpolyline points='17 8 12 3 7 8'%3E%3C/polyline%3E%3Cline x1='12' y1='3' x2='12' y2='15'%3E%3C/line%3E%3C/svg%3E"
                 class="mb-3" alt="Upload">
            <p class="mb-4 text-gray-500">Drag & drop PDF files here, or click to select files</p>
            <input type="file" name="pdf" multiple id="file-input" class="hidden" onchange="updateFileList()">
            <button type="button"
                    class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-lg transition duration-200 flex items-center"
                    onclick="document.getElementById('file-input').click()">
              <i class="fas fa-file-pdf mr-2"></i>
              Select PDF Files
            </button>
          </form>

          <div id="selected-files" class="mt-4 text-left"></div>

          <div class="mt-4" id="upload-button-container" style="display: none;">
            <button type="button"
                    class="bg-green-600 hover:bg-green-700 text-white px-5 py-2 rounded-lg transition duration-200 flex items-center mx-auto"
                    onclick="htmx.trigger('#upload-form', 'submit')">
              <i class="fas fa-upload mr-2"></i>
              Upload and Process Files
            </button>
          </div>
        </div>

        <!-- Processing animation -->
        <div id="processing-animation" class="htmx-indicator mt-6 fade-in">
          <div class="bg-blue-50 rounded-lg p-4">
            <div class="flex items-center mb-3">
              <div class="rounded-full bg-blue-100 p-2 mr-4">
                <i class="fas fa-cogs text-blue-600 text-xl pulse-animation"></i>
              </div>
              <div>
                <h3 class="font-medium text-blue-800">Processing your documents</h3>
                <p class="text-blue-600 text-sm">We're analyzing and vectorizing your PDFs. This may take a minute...</p>
              </div>
            </div>

            <!-- Progress bar -->
            <div class="h-2 bg-blue-100 rounded-full overflow-hidden">
              <div class="h-full bg-blue-500 progress-bar"></div>
            </div>

            <!-- Processing steps -->
            <div class="mt-3 grid grid-cols-3 gap-2 text-xs text-blue-700">
              <div class="flex items-center">
                <i class="fas fa-file-alt mr-1"></i>
                <span>Reading files</span>
              </div>
              <div class="flex items-center">
                <i class="fas fa-brain mr-1"></i>
                <span>Computing embeddings</span>
              </div>
              <div class="flex items-center">
                <i class="fas fa-database mr-1"></i>
                <span>Storing vectors</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Upload result area -->
        <div id="upload-result" class="mt-4"></div>
      </div>

      <!-- Document List Section -->
      <div>
        <h3 class="text-md font-medium mb-4 flex items-center">
          <i class="fas fa-list text-indigo-500 mr-2"></i>
          Document Library
        </h3>

        <div id="files-list" class="min-h-[200px]" hx-get="{% url 'files_view' %}" hx-trigger="load">
          <!-- This content will be replaced via HTMX -->
          <div class="flex justify-center items-center h-[200px]">
            <i class="fas fa-spinner fa-spin text-gray-400 text-2xl"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Success/Error message templates -->
  <template id="success-template">
    <div class="bg-green-50 text-green-800 rounded-lg p-4 flex items-center fade-in">
      <i class="fas fa-check-circle text-green-600 text-xl mr-3"></i>
      <div>
        <h3 class="font-medium">Documents processed successfully!</h3>
        <p class="text-sm">Your files have been uploaded and are ready for queries.</p>
      </div>
    </div>
  </template>

  <template id="error-template">
    <div class="bg-red-50 text-red-800 rounded-lg p-4 flex items-center fade-in">
      <i class="fas fa-exclamation-circle text-red-600 text-xl mr-3"></i>
      <div>
        <h3 class="font-medium">Error processing documents</h3>
        <p class="text-sm error-message">Something went wrong. Please try again.</p>
      </div>
    </div>
  </template>

  <!-- JavaScript -->
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      // Configure HTMX with CSRF token
      document.body.addEventListener("htmx:configRequest", function(event) {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        event.detail.headers["X-CSRFToken"] = csrfToken;
      });

      // Add direct click handler for delete buttons
      document.addEventListener('click', function(e) {
        // Find if the click is on a delete button or its icon
        let target = e.target;

        // If clicked on the icon, get the button parent
        if (target.tagName === 'I' && target.classList.contains('fa-trash')) {
          target = target.closest('button');
        }

        // Check if this is a delete button
        if (target.tagName === 'BUTTON' &&
            target.closest('form') &&
            target.closest('form').getAttribute('hx-post') &&
            target.closest('form').getAttribute('hx-post').includes('remove_file')) {

          // Prevent default form submission
          e.preventDefault();
          e.stopPropagation();

          // Get form and file name
          const form = target.closest('form');
          const fileNameInput = form.querySelector('input[name="file_name"]');
          const fileName = fileNameInput ? fileNameInput.value : "this document";

          // Show confirmation modal
          showDeleteConfirmation(form, fileName);
        }
      });
    });

    // Function to show delete confirmation modal
    function showDeleteConfirmation(form, fileName) {
      // Create and show the confirmation modal
      const modal = document.createElement('div');
      modal.id = 'delete-confirmation-modal';
      modal.className = 'fixed inset-0 flex items-center justify-center z-50';
      modal.innerHTML = `
        <div class="fixed inset-0 bg-black bg-opacity-30" id="modal-backdrop"></div>
        <div class="bg-white rounded-lg shadow-lg p-6 w-80 relative z-10 fade-in">
          <h3 class="text-lg font-medium mb-3 text-gray-800">Confirm Delete</h3>
          <p class="text-gray-600 mb-4">Are you sure you want to remove "${fileName}"?</p>
          <div class="flex justify-end space-x-2">
            <button id="cancel-delete" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded text-gray-800 transition duration-200">Cancel</button>
            <button id="confirm-delete" class="px-4 py-2 bg-red-500 hover:bg-red-600 rounded text-white transition duration-200">Delete</button>
          </div>
        </div>
      `;

      // Remove any existing modals first
      const existingModal = document.getElementById('delete-confirmation-modal');
      if (existingModal) {
        document.body.removeChild(existingModal);
      }

      document.body.appendChild(modal);

      // Handle backdrop click
      document.getElementById('modal-backdrop').addEventListener('click', function() {
        document.body.removeChild(modal);
      });

      // Handle cancel button
      document.getElementById('cancel-delete').addEventListener('click', function() {
        document.body.removeChild(modal);
      });

      // Handle confirm button - direct form submission approach
      document.getElementById('confirm-delete').addEventListener('click', function() {
        // Close the modal
        document.body.removeChild(modal);

        // Use a normal form submission to avoid HTMX complications
        const formData = new FormData();
        formData.append('file_name', fileName);
        formData.append('csrfmiddlewaretoken', form.querySelector('[name="csrfmiddlewaretoken"]').value);

        // Use fetch API for the request
        fetch(form.getAttribute('hx-post'), {
          method: 'POST',
          body: formData,
          headers: {
            'X-CSRFToken': form.querySelector('[name="csrfmiddlewaretoken"]').value
          }
        })
        .then(response => {
          if (response.ok) {
            // Refresh the file list
            updateFilesList();
          }
        });
      });
    }

    function updateFileList() {
      const fileInput = document.getElementById('file-input');
      const fileList = document.getElementById('selected-files');
      const uploadButton = document.getElementById('upload-button-container');

      if (fileInput.files.length > 0) {
        let fileListHTML = '<ul class="mt-3 space-y-1">';
        for (let i = 0; i < fileInput.files.length; i++) {
          const file = fileInput.files[i];
          fileListHTML += `
            <li class="flex items-center text-sm fade-in">
              <i class="fas fa-file-pdf text-red-500 mr-2"></i>
              <span class="truncate">${file.name}</span>
              <span class="text-gray-500 ml-2">(${formatFileSize(file.size)})</span>
            </li>
          `;
        }
        fileListHTML += '</ul>';
        fileList.innerHTML = fileListHTML;
        uploadButton.style.display = 'block';
      } else {
        fileList.innerHTML = '';
        uploadButton.style.display = 'none';
      }
    }

    function hideUploadButton() {
      document.getElementById('selected-files').innerHTML = '';
      document.getElementById('upload-button-container').style.display = 'none';
      document.getElementById('file-input').value = '';
    }

    function updateFilesList() {
      htmx.ajax('GET', '{% url "files_view" %}?partial=true', { target: '#files-list' });
    }

    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';

      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));

      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // Handle upload form submission
    document.addEventListener('htmx:afterRequest', function(evt) {
      if (evt.detail.elt.id === 'upload-form') {
        // Reset the form regardless of outcome
        document.getElementById('upload-form').reset();
        document.getElementById('selected-files').innerHTML = '';
        document.getElementById('upload-button-container').style.display = 'none';
        document.getElementById('file-input').value = '';

        if (evt.detail.successful) {
          // Show success message
          document.getElementById('upload-result').innerHTML = document.getElementById('success-template').innerHTML;

          // Refresh the file list
          updateFilesList();

          // Hide the success message after 3 seconds
          setTimeout(function() {
            document.getElementById('upload-result').innerHTML = '';
          }, 3000);
        } else {
          // Show error message
          document.getElementById('upload-result').innerHTML = document.getElementById('error-template').innerHTML;
        }
      }
    });
  </script>
</body>
</html>